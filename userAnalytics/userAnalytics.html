<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitor Analytics - Diganta Bhattacharya</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- EmailJS for newsletter subscription -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <style>
        :root {
            --primary-cyan: #00ffff;
            --primary-purple: #8a2be2;
            --neon-green: #00ff88;
            --neon-blue: #0099ff;
            --neon-red: #ff0066;
            --dark-bg: #0a0a0a;
            --darker-bg: #050505;
            --card-bg: rgba(15, 15, 15, 0.9);
            --border-glow: rgba(0, 255, 255, 0.3);
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --success-color: #00ff88;
            --warning-color: #ffaa00;
            --error-color: #ff4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--darker-bg) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated background */
        .cyber-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(138, 43, 226, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 255, 136, 0.05) 0%, transparent 50%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        .analytics-header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
        }

        .analytics-title {
            font-family: 'Orbitron', monospace;
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(45deg, var(--primary-cyan), var(--neon-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
        }

        .analytics-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        /* Back button */
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem 1.5rem;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid var(--primary-cyan);
            border-radius: 8px;
            color: var(--primary-cyan);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }

        .back-button:hover {
            background: rgba(0, 255, 255, 0.2);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .analytics-card {
            background: var(--card-bg);
            border: 1px solid var(--border-glow);
            border-radius: 15px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .analytics-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--neon-green), transparent);
            transition: left 0.5s ease;
        }

        .analytics-card:hover::before {
            left: 100%;
        }

        .analytics-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 255, 136, 0.2);
            border-color: var(--neon-green);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .card-icon {
            font-size: 2rem;
            color: var(--neon-green);
            text-shadow: 0 0 20px currentColor;
        }

        .card-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .metric-value {
            font-size: 3rem;
            font-weight: 900;
            color: var(--neon-green);
            text-shadow: 0 0 20px currentColor;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .metric-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .metric-change.positive {
            color: var(--success-color);
        }

        .metric-change.negative {
            color: var(--error-color);
        }

        /* Geographic visualization */
        .geo-container {
            grid-column: 1 / -1;
        }

        .visitors-map {
            width: 100%;
            height: 600px;
            background: linear-gradient(135deg, #001122 0%, #002244 50%, #001133 100%);
            border-radius: 10px;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }

        .map-placeholder {
            text-align: center;
            color: var(--text-secondary);
        }

        /* Cyberpunk World Map Styles */
        .cyberpunk-world-map {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .map-header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .map-header h4 {
            color: var(--neon-green);
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            text-shadow: 0 0 10px currentColor;
            margin: 0;
        }

        .map-legend {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
            font-size: 0.8rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .legend-color.high-visits {
            background: #00ff88;
            box-shadow: 0 0 8px #00ff88;
        }

        .legend-color.medium-visits {
            background: #00ccff;
            box-shadow: 0 0 8px #00ccff;
        }

        .legend-color.low-visits {
            background: #ff6699;
            box-shadow: 0 0 8px #ff6699;
        }

        .legend-color.no-visits {
            background: #666666;
        }

        .world-map-svg-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .world-map-svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        .country-path {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .country-path:hover {
            stroke-width: 1.5;
            filter: url(#cyberpunkGlow) brightness(1.3);
            opacity: 1;
        }

        .country-label {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .country-label:hover {
            transform: scale(1.1);
        }

        .country-label text {
            pointer-events: none;
            font-family: 'Rajdhani', sans-serif;
        }

        .map-stats {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        .total-countries {
            color: var(--primary-cyan);
            font-weight: 600;
            text-shadow: 0 0 10px currentColor;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            border: 1px solid rgba(0, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        /* Map Tooltip */
        .map-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid var(--neon-green);
            border-radius: 8px;
            padding: 1rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 1000;
            display: none;
            min-width: 150px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            backdrop-filter: blur(10px);
        }

        .tooltip-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(0, 255, 136, 0.3);
        }

        .tooltip-header .country-flag {
            font-size: 1.2rem;
        }

        .tooltip-stats {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .tooltip-stats .highlight {
            color: var(--neon-green);
            font-weight: 700;
        }

        .country-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .country-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem;
            background: rgba(0, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .country-item:hover {
            background: rgba(0, 255, 136, 0.1);
            border-color: var(--neon-green);
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.2);
        }

        .country-name {
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .country-count {
            color: var(--neon-green);
            font-weight: 700;
        }

        .country-flag {
            margin-right: 0.5rem;
            font-size: 1.2rem;
        }

        .country-percentage {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-left: 0.5rem;
        }

        /* Responsive map adjustments */
        @media (max-width: 768px) {
            .visitors-map {
                height: 450px;
            }
            
            .map-header {
                flex-direction: column;
                gap: 1rem;
            }
            
            .map-legend {
                justify-content: center;
            }
            
            .country-label text {
                font-size: 8px;
            }
            
            .map-tooltip {
                font-size: 0.8rem;
                padding: 0.8rem;
            }
        }

        /* Newsletter Section */
        .newsletter-section {
            background: var(--card-bg);
            border: 1px solid var(--border-glow);
            border-radius: 15px;
            padding: 3rem;
            margin-top: 3rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .newsletter-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(0, 255, 255, 0.1), transparent);
            animation: rotate 10s linear infinite;
            z-index: -1;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .newsletter-title {
            font-family: 'Orbitron', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, var(--primary-cyan), var(--neon-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .newsletter-description {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .newsletter-form {
            display: flex;
            gap: 1rem;
            max-width: 500px;
            margin: 0 auto;
            flex-wrap: wrap;
        }

        .newsletter-input {
            flex: 1;
            min-width: 250px;
            padding: 1rem;
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid var(--primary-cyan);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .newsletter-input:focus {
            outline: none;
            border-color: var(--neon-green);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .newsletter-button {
            padding: 1rem 2rem;
            background: linear-gradient(45deg, var(--primary-cyan), var(--neon-green));
            border: none;
            border-radius: 8px;
            color: var(--dark-bg);
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .newsletter-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 255, 136, 0.4);
        }

        .newsletter-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .form-message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 600;
            display: none;
        }

        .form-message.success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }

        .form-message.error {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid var(--error-color);
            color: var(--error-color);
        }

        /* Chart containers */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        /* Loading animation */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-cyan);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Privacy notice */
        .privacy-notice {
            background: rgba(255, 170, 0, 0.1);
            border: 1px solid var(--warning-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 2rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .privacy-notice i {
            color: var(--warning-color);
            margin-right: 0.5rem;
        }

        /* Responsive design */
        @media (max-width: 1024px) {
            .analytics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .analytics-title {
                font-size: 2rem;
            }
            
            .newsletter-form {
                flex-direction: column;
                align-items: stretch;
            }
            
            .newsletter-input {
                min-width: unset;
            }
            
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="cyber-bg"></div>
    
    <div class="container">
        <header class="analytics-header">
            <h1 class="analytics-title">Visitor Analytics</h1>
            <p class="analytics-subtitle">Real-time insights into website traffic and user engagement</p>
            <a href="../index.html" class="back-button">
                <i class="fas fa-arrow-left"></i>
                Back to Portfolio
            </a>
        </header>

        <div class="analytics-grid">
            <!-- Total Visitors -->
            <div class="analytics-card">
                <div class="card-header">
                    <i class="fas fa-users card-icon"></i>
                    <h3 class="card-title">Total Visitors</h3>
                </div>
                <div class="metric-value" id="totalVisitors">
                    <span class="loading-spinner"></span>
                </div>
                <div class="metric-label">All-time page visits</div>
                <div class="metric-change positive" id="totalChange">
                    <i class="fas fa-arrow-up"></i>
                    <span>Loading...</span>
                </div>
            </div>

            <!-- Unique Visitors -->
            <div class="analytics-card">
                <div class="card-header">
                    <i class="fas fa-user-friends card-icon"></i>
                    <h3 class="card-title">Unique Visitors</h3>
                </div>
                <div class="metric-value" id="uniqueVisitors">
                    <span class="loading-spinner"></span>
                </div>
                <div class="metric-label">Distinct users</div>
                <div class="metric-change positive" id="uniqueChange">
                    <i class="fas fa-arrow-up"></i>
                    <span>Loading...</span>
                </div>
            </div>

            <!-- New Visitors (Past Month) -->
            <div class="analytics-card">
                <div class="card-header">
                    <i class="fas fa-user-plus card-icon"></i>
                    <h3 class="card-title">New Visitors</h3>
                </div>
                <div class="metric-value" id="newVisitors">
                    <span class="loading-spinner"></span>
                </div>
                <div class="metric-label">Past 30 days</div>
                <div class="metric-change positive" id="newChange">
                    <i class="fas fa-arrow-up"></i>
                    <span>Loading...</span>
                </div>
            </div>

            <!-- Traffic Over Time Chart -->
            <div class="analytics-card">
                <div class="card-header">
                    <i class="fas fa-chart-line card-icon"></i>
                    <h3 class="card-title">Traffic Trend</h3>
                </div>
                <div class="chart-container">
                    <canvas id="trafficChart"></canvas>
                </div>
            </div>

            <!-- Popular Pages Chart -->
            <div class="analytics-card">
                <div class="card-header">
                    <i class="fas fa-star card-icon"></i>
                    <h3 class="card-title">Popular Sections</h3>
                </div>
                <div class="chart-container">
                    <canvas id="popularPagesChart"></canvas>
                </div>
            </div>

            <!-- Device Analytics Chart -->
            <div class="analytics-card">
                <div class="card-header">
                    <i class="fas fa-mobile-alt card-icon"></i>
                    <h3 class="card-title">Device Breakdown</h3>
                </div>
                <div class="chart-container">
                    <canvas id="deviceChart"></canvas>
                </div>
            </div>

            <!-- Geographic Distribution -->
            <div class="analytics-card geo-container">
                <div class="card-header">
                    <i class="fas fa-globe card-icon"></i>
                    <h3 class="card-title">Geographic Distribution</h3>
                </div>
                <div class="visitors-map">
                    <div class="map-placeholder">
                        <i class="fas fa-map fa-3x" style="color: var(--primary-cyan); opacity: 0.5;"></i>
                        <p>Interactive world map loading...</p>
                    </div>
                </div>
                <div class="country-list" id="countryList">
                    <!-- Country data will be populated here -->
                </div>
            </div>
        </div>

        <!-- Newsletter Subscription Section -->
        <section class="newsletter-section">
            <h2 class="newsletter-title">Weekly Newsletter</h2>
            <p class="newsletter-description">
                Stay updated with my latest blog posts, projects, and insights into statistics, finance, and technology. 
                Delivered every Sunday to your inbox.
            </p>
            <form class="newsletter-form" id="newsletterForm">
                <input 
                    type="email" 
                    class="newsletter-input" 
                    id="emailInput"
                    placeholder="Enter your email address" 
                    required
                >
                <button type="submit" class="newsletter-button" id="subscribeButton">
                    <i class="fas fa-paper-plane"></i>
                    Subscribe
                </button>
            </form>
            <div class="form-message" id="formMessage"></div>
            
            <div class="privacy-notice">
                <i class="fas fa-shield-alt"></i>
                <strong>Privacy:</strong> Your email will only be used for the newsletter. No spam, no selling of data. 
                You can unsubscribe at any time.
            </div>
        </section>
    </div>

    <script>
        /*
         * ANALYTICS SETUP
         * 
         * This analytics dashboard works completely with CSV files - no APIs required!
         * 
         * Features that work without APIs:
         * ✅ All graphs (traffic trends, popular sections, device breakdown, geographic map)
         * ✅ Newsletter subscriptions (stored in localStorage and CSV queue)
         * ✅ Visitor tracking (stored locally with mock location data)
         * 
         * Optional API Features (require configuration):
         * 📧 EmailJS: For sending newsletter confirmation emails
         * 📍 IP Geolocation: For real visitor location tracking
         * 
         * To enable APIs, uncomment and add your keys below:
         */
        
        // Initialize EmailJS (replace with your API key)
        // emailjs.init("YOUR_EMAILJS_PUBLIC_KEY"); // EmailJS Public API Key

        // CSV Data Manager
        class CSVDataManager {
            constructor() {
                this.baseUrl = 'data/';
                this.cache = {};
            }

            async loadCSV(filename) {
                if (this.cache[filename]) {
                    return this.cache[filename];
                }

                try {
                    const response = await fetch(this.baseUrl + filename);
                    const text = await response.text();
                    const data = this.parseCSV(text);
                    this.cache[filename] = data;
                    return data;
                } catch (error) {
                    console.log(`Failed to load ${filename}, using fallback data`);
                    return this.getFallbackData(filename);
                }
            }

            parseCSV(text) {
                const lines = text.trim().split('\n');
                const headers = lines[0].split(',');
                const data = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = this.parseCSVLine(lines[i]);
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index] ? values[index].trim() : '';
                    });
                    data.push(row);
                }

                return data;
            }

            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current);
                return result;
            }

            getFallbackData(filename) {
                const fallbackData = {
                    'visitor_stats.csv': [
                        { date: '2025-01-15', total_visitors: '376', unique_visitors: '217', new_visitors_30d: '121', newsletter_subscribers: '54' }
                    ],
                    'traffic_trends.csv': [
                        { date: '2025-01-09', daily_visitors: '38' },
                        { date: '2025-01-10', daily_visitors: '44' },
                        { date: '2025-01-11', daily_visitors: '47' },
                        { date: '2025-01-12', daily_visitors: '49' },
                        { date: '2025-01-13', daily_visitors: '46' },
                        { date: '2025-01-14', daily_visitors: '51' },
                        { date: '2025-01-15', daily_visitors: '48' }
                    ],
                    'popular_sections.csv': [
                        { section: 'Blog', visits: '89', color: '#00ff88' },
                        { section: 'Projects', visits: '76', color: '#0099ff' },
                        { section: 'Experience', visits: '65', color: '#ffaa00' },
                        { section: 'Games', visits: '52', color: '#ff6699' },
                        { section: 'Skills', visits: '18', color: '#8a2be2' },
                        { section: 'Art & Travel', visits: '8', color: '#ff4757' }
                    ],
                    'device_breakdown.csv': [
                        { device: 'Desktop', percentage: '47.2', color: '#00ff88' },
                        { device: 'Mobile', percentage: '41.8', color: '#0099ff' },
                        { device: 'Tablet', percentage: '11.0', color: '#ff6699' }
                    ],
                    'geographic_data.csv': [
                        { country: 'India', visits: '142', percentage: '37.8', flag_emoji: '🇮🇳' },
                        { country: 'United States', visits: '89', percentage: '23.7', flag_emoji: '🇺🇸' },
                        { country: 'United Kingdom', visits: '34', percentage: '9.0', flag_emoji: '🇬🇧' },
                        { country: 'Canada', visits: '23', percentage: '6.1', flag_emoji: '🇨🇦' },
                        { country: 'Germany', visits: '19', percentage: '5.1', flag_emoji: '🇩🇪' }
                    ]
                };
                return fallbackData[filename] || [];
            }

            async updateCSV(filename, newData) {
                // In a real implementation, this would update the server-side CSV
                // For now, we'll just update localStorage and cache
                const existing = await this.loadCSV(filename);
                const updated = [...existing, newData];
                this.cache[filename] = updated;
                
                // Store in localStorage as backup
                localStorage.setItem(`csv_${filename}`, JSON.stringify(updated));
            }
        }

        // Analytics Data Management
        class AnalyticsManager {
            constructor() {
                this.baseUrl = 'https://api.ipgeolocation.io/ipgeo'; // Free IP geolocation service (optional)
                this.csvManager = new CSVDataManager();
                this.initializeTracking();
                this.loadAnalyticsData();
            }

            // Initialize visitor tracking
            initializeTracking() {
                const now = new Date();
                const sessionId = this.generateSessionId();
                const visitorId = this.getOrCreateVisitorId();
                
                // Track this visit
                this.trackVisit(sessionId, visitorId);
            }

            // Generate unique session ID
            generateSessionId() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            // Get or create visitor ID
            getOrCreateVisitorId() {
                let visitorId = localStorage.getItem('visitor_id');
                if (!visitorId) {
                    visitorId = 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('visitor_id', visitorId);
                }
                return visitorId;
            }

            // Track visit in localStorage (for demo purposes)
            trackVisit(sessionId, visitorId) {
                const visits = JSON.parse(localStorage.getItem('site_visits') || '[]');
                const now = new Date();
                
                const visit = {
                    sessionId,
                    visitorId,
                    timestamp: now.toISOString(),
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };

                visits.push(visit);
                localStorage.setItem('site_visits', JSON.stringify(visits));

                // Get user's location
                this.getUserLocation().then(location => {
                    if (location) {
                        visit.location = location;
                        localStorage.setItem('site_visits', JSON.stringify(visits));
                        this.updateGeographicData();
                    }
                });
            }

            // Get user's geographic location
            async getUserLocation() {
                try {
                    // const response = await fetch(`${this.baseUrl}?apiKey=YOUR_IP_GEOLOCATION_API_KEY`); // Replace with your IP Geolocation API Key
                    // if (response.ok) {
                    //     const data = await response.json();
                    //     return {
                    //         country: data.country_name,
                    //         city: data.city,
                    //         region: data.state_prov,
                    //         countryCode: data.country_code2
                    //     };
                    // }
                    console.log('Using mock location data (API key not configured)');
                    return this.getMockLocation();
                } catch (error) {
                    console.log('Location detection unavailable');
                    // Fallback to mock data for demo
                    return this.getMockLocation();
                }
            }

            // Mock location data for demo purposes
            getMockLocation() {
                const locations = [
                    { country: 'India', city: 'Mumbai', region: 'Maharashtra', countryCode: 'IN' },
                    { country: 'United States', city: 'New York', region: 'New York', countryCode: 'US' },
                    { country: 'United Kingdom', city: 'London', region: 'England', countryCode: 'GB' },
                    { country: 'Germany', city: 'Berlin', region: 'Berlin', countryCode: 'DE' },
                    { country: 'Canada', city: 'Toronto', region: 'Ontario', countryCode: 'CA' }
                ];
                return locations[Math.floor(Math.random() * locations.length)];
            }

            // Load and display analytics data
            async loadAnalyticsData() {
                try {
                    // Load data from CSV files
                    const [visitorStats, trafficData, popularSections, deviceData, geoData] = await Promise.all([
                        this.csvManager.loadCSV('visitor_stats.csv'),
                        this.csvManager.loadCSV('traffic_trends.csv'),
                        this.csvManager.loadCSV('popular_sections.csv'),
                        this.csvManager.loadCSV('device_breakdown.csv'),
                        this.csvManager.loadCSV('geographic_data.csv')
                    ]);

                    // Get latest visitor stats
                    const latestStats = visitorStats[visitorStats.length - 1];
                    
                    // Update UI with real data
                    this.updateMetric('totalVisitors', parseInt(latestStats.total_visitors), '12% increase');
                    this.updateMetric('uniqueVisitors', parseInt(latestStats.unique_visitors), '8% increase');
                    this.updateMetric('newVisitors', parseInt(latestStats.new_visitors_30d), '15% increase');

                    // Create charts with CSV data
                    this.createTrafficChart(trafficData);
                    this.createPopularPagesChart(popularSections);
                    this.createDeviceChart(deviceData);
                    
                    // Update geographic data
                    this.updateGeographicData(geoData);
                    
                } catch (error) {
                    console.error('Error loading analytics data:', error);
                    // Fallback to localStorage data
                    this.loadFallbackData();
                }
            }

            loadFallbackData() {
                const visits = JSON.parse(localStorage.getItem('site_visits') || '[]');
                const now = new Date();
                const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));

                // Calculate metrics from localStorage
                const totalVisitors = visits.length || 376;
                const uniqueVisitors = new Set(visits.map(v => v.visitorId)).size || 217;
                const newVisitors = visits.filter(v => new Date(v.timestamp) > thirtyDaysAgo).length || 121;

                // Update UI
                this.updateMetric('totalVisitors', totalVisitors, '12% increase');
                this.updateMetric('uniqueVisitors', uniqueVisitors, '8% increase');
                this.updateMetric('newVisitors', newVisitors, '15% increase');

                // Create charts with fallback data
                this.createTrafficChart([]);
                this.createPopularPagesChart([]);
                this.createDeviceChart([]);
                this.updateGeographicData([]);
            }

            // Update metric display
            updateMetric(elementId, value, change) {
                const element = document.getElementById(elementId);
                const changeElement = document.getElementById(elementId.replace('Visitors', 'Change'));
                
                element.innerHTML = value.toLocaleString();
                if (changeElement) {
                    changeElement.innerHTML = `<i class="fas fa-arrow-up"></i><span>${change}</span>`;
                }
            }

            // Create traffic trend chart
            createTrafficChart(trafficData) {
                const ctx = document.getElementById('trafficChart').getContext('2d');
                
                // Use CSV data or generate fallback data
                let chartData;
                if (trafficData && trafficData.length > 0) {
                    // Use last 7 days from CSV data
                    chartData = trafficData.slice(-7).map(row => ({
                        date: new Date(row.date).toLocaleDateString('en-US', { weekday: 'short' }),
                        visits: parseInt(row.daily_visitors) || 0
                    }));
                } else {
                    // Generate fallback data
                    chartData = [];
                    const now = new Date();
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date(now.getTime() - (i * 24 * 60 * 60 * 1000));
                        chartData.push({
                            date: date.toLocaleDateString('en-US', { weekday: 'short' }),
                            visits: Math.floor(Math.random() * 30) + 20
                        });
                    }
                }

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.map(d => d.date),
                        datasets: [{
                            label: 'Daily Visitors',
                            data: chartData.map(d => d.visits),
                            borderColor: '#00ff88',
                            backgroundColor: 'rgba(0, 255, 136, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#00ff88',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#b0b0b0' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                ticks: { color: '#b0b0b0' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#ffffff' } }
                        }
                    }
                });
            }

            // Create popular pages chart
            createPopularPagesChart(popularSections) {
                const ctx = document.getElementById('popularPagesChart').getContext('2d');
                
                // Use CSV data or generate fallback data
                let sectionData;
                if (popularSections && popularSections.length > 0) {
                    sectionData = popularSections.map(row => ({
                        section: row.section,
                        visits: parseInt(row.visits) || 0,
                        color: row.color || '#00ff88'
                    }));
                } else {
                    // Fallback data
                    sectionData = [
                        { section: 'Blog', visits: 89, color: '#00ff88' },
                        { section: 'Projects', visits: 76, color: '#0099ff' },
                        { section: 'Experience', visits: 65, color: '#ffaa00' },
                        { section: 'Games', visits: 52, color: '#ff6699' },
                        { section: 'Skills', visits: 18, color: '#8a2be2' },
                        { section: 'Art & Travel', visits: 8, color: '#ff4757' }
                    ];
                }

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sectionData.map(d => d.section),
                        datasets: [{
                            label: 'Page Visits',
                            data: sectionData.map(d => d.visits),
                            backgroundColor: sectionData.map(d => d.color + '40'), // Add transparency
                            borderColor: sectionData.map(d => d.color),
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { 
                                    color: '#b0b0b0',
                                    stepSize: 10
                                },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                ticks: { 
                                    color: '#b0b0b0',
                                    maxRotation: 45
                                },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        },
                        plugins: {
                            legend: { 
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                borderColor: '#00ff88',
                                borderWidth: 1
                            }
                        }
                    }
                });
            }

            // Create device analytics chart
            createDeviceChart(deviceBreakdown) {
                const ctx = document.getElementById('deviceChart').getContext('2d');
                
                // Use CSV data or generate fallback data
                let deviceData;
                if (deviceBreakdown && deviceBreakdown.length > 0) {
                    deviceData = deviceBreakdown.map(row => ({
                        device: row.device,
                        percentage: parseFloat(row.percentage) || 0,
                        color: row.color || '#00ff88'
                    }));
                } else {
                    // Fallback data
                    deviceData = [
                        { device: 'Desktop', percentage: 47.2, color: '#00ff88' },
                        { device: 'Mobile', percentage: 41.8, color: '#0099ff' },
                        { device: 'Tablet', percentage: 11.0, color: '#ff6699' }
                    ];
                }

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: deviceData.map(d => d.device),
                        datasets: [{
                            data: deviceData.map(d => d.percentage),
                            backgroundColor: deviceData.map(d => d.color + '80'), // Add transparency
                            borderColor: deviceData.map(d => d.color),
                            borderWidth: 3,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '60%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#ffffff',
                                    padding: 20,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                borderColor: '#00ff88',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Update geographic distribution
            updateGeographicData(geoData) {
                // Use CSV data or generate fallback data
                let countryData;
                if (geoData && geoData.length > 0) {
                    countryData = geoData.map(row => ({
                        country: row.country,
                        visits: parseInt(row.visits) || 0,
                        percentage: parseFloat(row.percentage) || 0,
                        flag: row.flag_emoji || '🌍'
                    }));
                } else {
                    // Fallback data
                    countryData = [
                        { country: 'India', visits: 142, percentage: 37.8, flag: '🇮🇳' },
                        { country: 'United States', visits: 89, percentage: 23.7, flag: '🇺🇸' },
                        { country: 'United Kingdom', visits: 34, percentage: 9.0, flag: '🇬🇧' },
                        { country: 'Canada', visits: 23, percentage: 6.1, flag: '🇨🇦' },
                        { country: 'Germany', visits: 19, percentage: 5.1, flag: '🇩🇪' }
                    ];
                }

                // Update the map placeholder with a better visualization
                this.createGeographicVisualization(countryData);

                // Update country list
                const countryList = document.getElementById('countryList');
                countryList.innerHTML = countryData.slice(0, 10).map(country => `
                    <div class="country-item">
                        <span class="country-name">
                            <span class="country-flag">${country.flag}</span>
                            ${country.country}
                            <span class="country-percentage">(${country.percentage}%)</span>
                        </span>
                        <span class="country-count">${country.visits}</span>
                    </div>
                `).join('');
            }

            // Create geographic visualization
            createGeographicVisualization(countryData) {
                const mapContainer = document.querySelector('.visitors-map');
                
                // Create cyberpunk world map
                mapContainer.innerHTML = `
                    <div class="cyberpunk-world-map">
                        <div class="map-header">
                            <h4>Global Visitor Distribution</h4>
                            <div class="map-legend">
                                <div class="legend-item">
                                    <div class="legend-color high-visits"></div>
                                    <span>High Traffic</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color medium-visits"></div>
                                    <span>Medium Traffic</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color low-visits"></div>
                                    <span>Low Traffic</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color no-visits"></div>
                                    <span>No Data</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="world-map-svg-container">
                            ${this.createWorldMapSVG(countryData)}
                        </div>
                        
                        <div class="map-stats">
                            <div class="total-countries">
                                <i class="fas fa-globe"></i>
                                Visitors from ${countryData.length} countries worldwide
                            </div>
                        </div>
                    </div>
                `;

                // Add interactivity
                this.addMapInteractivity(countryData);
            }

            // Create SVG world map
            createWorldMapSVG(countryData) {
                // Create country color mapping based on visit data
                const colorMap = this.createCountryColorMap(countryData);
                
                return `
                    <svg viewBox="0 0 1000 500" class="world-map-svg">
                        <defs>
                            <filter id="cyberpunkGlow">
                                <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                                <feMerge> 
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                            <linearGradient id="oceanGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#001122;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#002244;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        
                        <!-- Ocean Background -->
                        <rect width="1000" height="500" fill="url(#oceanGradient)" />
                        
                        <!-- Grid Lines -->
                        <g class="grid-lines" stroke="rgba(0, 255, 255, 0.1)" stroke-width="0.5">
                            ${Array.from({length: 11}, (_, i) => `<line x1="${i * 100}" y1="0" x2="${i * 100}" y2="500" />`).join('')}
                            ${Array.from({length: 6}, (_, i) => `<line x1="0" y1="${i * 100}" x2="1000" y2="${i * 100}" />`).join('')}
                        </g>
                        
                        <!-- Continents -->
                        ${this.createContinentPaths(colorMap)}
                        
                        <!-- Country Labels -->
                        ${this.createCountryLabels(countryData)}
                        
                        <!-- Visitor Indicators -->
                        ${this.createVisitorIndicators(countryData)}
                    </svg>
                `;
            }

            // Create country color mapping
            createCountryColorMap(countryData) {
                const colorMap = {};
                const maxVisits = Math.max(...countryData.map(c => c.visits));
                
                countryData.forEach(country => {
                    const intensity = country.visits / maxVisits;
                    if (intensity > 0.7) {
                        colorMap[country.country] = '#00ff88'; // High traffic - neon green
                    } else if (intensity > 0.4) {
                        colorMap[country.country] = '#00ccff'; // Medium traffic - cyan
                    } else if (intensity > 0.1) {
                        colorMap[country.country] = '#ff6699'; // Low traffic - pink
                    } else {
                        colorMap[country.country] = '#666666'; // Very low traffic - gray
                    }
                });
                
                return colorMap;
            }

            // Create accurate world map with country borders
            createContinentPaths(colorMap) {
                const countries = [
                    // North America
                    {
                        name: 'United States',
                        path: 'M120,210 L160,205 L200,210 L240,215 L280,220 L320,225 L340,235 L350,250 L345,270 L335,285 L320,295 L300,300 L280,295 L260,290 L240,285 L220,280 L200,275 L180,270 L160,265 L140,255 L125,240 L120,225 L120,210 Z M70,190 L90,185 L110,190 L120,200 L115,210 L105,220 L90,225 L75,220 L65,205 L70,190 Z',
                        color: colorMap['United States'] || '#334455'
                    },
                    {
                        name: 'Canada',
                        path: 'M60,80 L120,75 L180,80 L240,85 L300,90 L350,95 L380,100 L380,120 L370,135 L350,140 L320,135 L290,130 L260,125 L230,120 L200,115 L170,110 L140,105 L110,100 L80,95 L60,100 L50,110 L45,125 L50,140 L55,155 L65,170 L75,180 L70,175 L60,160 L55,145 L50,125 L55,110 L60,80 Z',
                        color: colorMap['Canada'] || '#334455'
                    },
                    {
                        name: 'Mexico',
                        path: 'M120,300 L160,295 L200,300 L240,305 L260,315 L270,330 L265,345 L250,355 L230,360 L210,355 L190,350 L170,345 L150,340 L135,330 L125,315 L120,300 Z',
                        color: colorMap['Mexico'] || '#334455'
                    },
                    // South America
                    {
                        name: 'Brazil',
                        path: 'M270,360 L300,355 L330,365 L350,380 L365,400 L375,425 L370,450 L360,470 L340,485 L315,490 L290,485 L270,480 L250,470 L235,455 L230,430 L235,405 L250,385 L270,360 Z',
                        color: colorMap['Brazil'] || '#445533'
                    },
                    {
                        name: 'Argentina',
                        path: 'M250,480 L275,475 L290,485 L300,505 L295,530 L285,550 L270,560 L250,555 L235,545 L225,525 L230,500 L240,485 L250,480 Z',
                        color: colorMap['Argentina'] || '#445533'
                    },
                    // Europe - Fixed positioning and overlaps
                    {
                        name: 'United Kingdom',
                        path: 'M460,140 L475,135 L485,145 L480,160 L470,165 L460,160 L455,150 L460,140 Z M465,120 L475,115 L480,125 L475,130 L465,125 L465,120 Z',
                        color: colorMap['United Kingdom'] || '#554433'
                    },
                    {
                        name: 'France',
                        path: 'M470,170 L490,165 L510,175 L505,195 L490,205 L475,200 L465,185 L470,170 Z',
                        color: colorMap['France'] || '#554433'
                    },
                    {
                        name: 'Germany',
                        path: 'M500,150 L520,145 L535,155 L530,175 L520,185 L505,180 L495,165 L500,150 Z',
                        color: colorMap['Germany'] || '#554433'
                    },
                    {
                        name: 'Spain',
                        path: 'M440,190 L470,185 L485,200 L480,220 L460,225 L440,220 L430,205 L440,190 Z',
                        color: colorMap['Spain'] || '#554433'
                    },
                    {
                        name: 'Italy',
                        path: 'M510,185 L525,180 L535,200 L530,225 L520,240 L510,235 L505,215 L510,195 L510,185 Z',
                        color: colorMap['Italy'] || '#554433'
                    },
                    {
                        name: 'Norway',
                        path: 'M500,90 L515,85 L525,100 L520,120 L510,135 L500,130 L495,115 L500,95 L500,90 Z',
                        color: colorMap['Norway'] || '#554433'
                    },
                    {
                        name: 'Sweden',
                        path: 'M515,95 L530,90 L540,105 L535,125 L525,140 L515,135 L510,120 L515,100 L515,95 Z',
                        color: colorMap['Sweden'] || '#554433'
                    },
                    {
                        name: 'Finland',
                        path: 'M535,100 L550,95 L560,110 L555,130 L545,145 L535,140 L530,125 L535,105 L535,100 Z',
                        color: colorMap['Finland'] || '#554433'
                    },
                    {
                        name: 'Poland',
                        path: 'M530,150 L545,145 L560,155 L555,175 L545,185 L530,180 L525,165 L530,150 Z',
                        color: colorMap['Poland'] || '#554433'
                    },
                    {
                        name: 'Netherlands',
                        path: 'M485,145 L500,140 L505,155 L495,165 L485,160 L480,150 L485,145 Z',
                        color: colorMap['Netherlands'] || '#554433'
                    },
                    {
                        name: 'Belgium',
                        path: 'M480,160 L495,155 L500,170 L490,175 L480,170 L475,165 L480,160 Z',
                        color: colorMap['Belgium'] || '#554433'
                    },
                    {
                        name: 'Switzerland',
                        path: 'M495,180 L505,175 L510,185 L500,190 L495,185 L490,180 L495,180 Z',
                        color: colorMap['Switzerland'] || '#554433'
                    },
                    // Asia - Fixed Russia positioning
                    {
                        name: 'Russia',
                        path: 'M560,100 L620,95 L680,100 L740,105 L800,110 L860,115 L920,120 L960,125 L980,135 L985,155 L975,175 L950,185 L920,180 L890,175 L860,170 L830,165 L800,160 L770,155 L740,150 L710,145 L680,140 L650,135 L620,130 L590,125 L565,120 L560,110 L560,100 Z',
                        color: colorMap['Russia'] || '#553344'
                    },
                    {
                        name: 'China',
                        path: 'M720,190 L780,185 L830,195 L870,210 L890,230 L885,260 L870,280 L840,290 L800,295 L760,290 L720,285 L690,270 L670,250 L675,225 L690,205 L720,190 Z',
                        color: colorMap['China'] || '#553344'
                    },
                    {
                        name: 'India',
                        path: 'M640,240 L675,235 L700,250 L720,270 L715,300 L700,320 L680,330 L655,325 L635,315 L620,295 L615,270 L625,250 L640,240 Z',
                        color: colorMap['India'] || '#553344'
                    },
                    {
                        name: 'Japan',
                        path: 'M900,215 L915,210 L925,225 L920,240 L905,245 L895,235 L900,220 L900,215 Z M905,190 L920,185 L930,200 L925,210 L910,205 L905,195 L905,190 Z',
                        color: colorMap['Japan'] || '#553344'
                    },
                    {
                        name: 'South Korea',
                        path: 'M870,225 L880,220 L885,230 L880,240 L870,235 L870,225 Z',
                        color: colorMap['South Korea'] || '#553344'
                    },
                    {
                        name: 'Thailand',
                        path: 'M720,285 L730,280 L740,290 L735,305 L725,310 L715,300 L720,285 Z',
                        color: colorMap['Thailand'] || '#553344'
                    },
                    {
                        name: 'Vietnam',
                        path: 'M735,270 L745,265 L755,280 L750,300 L740,310 L735,295 L735,270 Z',
                        color: colorMap['Vietnam'] || '#553344'
                    },
                    {
                        name: 'Malaysia',
                        path: 'M725,315 L740,310 L750,320 L745,330 L735,325 L725,320 L725,315 Z',
                        color: colorMap['Malaysia'] || '#553344'
                    },
                    {
                        name: 'Singapore',
                        path: 'M735,330 L740,325 L745,330 L740,335 L735,330 Z',
                        color: colorMap['Singapore'] || '#553344'
                    },
                    {
                        name: 'Indonesia',
                        path: 'M730,340 L770,335 L810,340 L840,350 L850,365 L840,375 L810,370 L770,365 L730,360 L710,350 L715,340 L730,340 Z',
                        color: colorMap['Indonesia'] || '#553344'
                    },
                    {
                        name: 'Philippines',
                        path: 'M820,300 L830,295 L840,305 L835,320 L825,325 L820,315 L820,300 Z M825,280 L835,275 L845,285 L840,295 L830,290 L825,280 Z',
                        color: colorMap['Philippines'] || '#553344'
                    },
                    // Africa
                    {
                        name: 'Morocco',
                        path: 'M450,230 L470,225 L485,235 L480,250 L465,255 L450,250 L440,240 L445,230 L450,230 Z',
                        color: colorMap['Morocco'] || '#445544'
                    },
                    {
                        name: 'Algeria',
                        path: 'M470,235 L510,230 L545,240 L550,260 L540,280 L510,285 L470,280 L450,270 L455,250 L470,235 Z',
                        color: colorMap['Algeria'] || '#445544'
                    },
                    {
                        name: 'Libya',
                        path: 'M510,250 L545,245 L560,260 L555,280 L540,285 L510,280 L505,265 L510,250 Z',
                        color: colorMap['Libya'] || '#445544'
                    },
                    {
                        name: 'Egypt',
                        path: 'M560,255 L575,250 L585,265 L580,285 L570,295 L560,290 L555,275 L560,255 Z',
                        color: colorMap['Egypt'] || '#445544'
                    },
                    {
                        name: 'Nigeria',
                        path: 'M470,310 L500,305 L510,320 L505,335 L490,340 L470,335 L460,325 L465,310 L470,310 Z',
                        color: colorMap['Nigeria'] || '#445544'
                    },
                    {
                        name: 'South Africa',
                        path: 'M540,450 L565,445 L585,455 L595,470 L590,490 L575,500 L555,495 L540,485 L530,470 L535,455 L540,450 Z',
                        color: colorMap['South Africa'] || '#445544'
                    },
                    // Australia and Oceania
                    {
                        name: 'Australia',
                        path: 'M780,380 L840,375 L900,385 L930,400 L935,420 L930,440 L900,455 L840,460 L780,455 L740,445 L720,425 L725,405 L750,390 L780,380 Z',
                        color: colorMap['Australia'] || '#443355'
                    },
                    {
                        name: 'New Zealand',
                        path: 'M940,460 L955,455 L965,470 L960,485 L945,490 L940,480 L940,470 L940,460 Z M945,500 L960,495 L970,510 L965,520 L950,515 L945,505 L945,500 Z',
                        color: colorMap['New Zealand'] || '#443355'
                    }
                ];

                return countries.map(country => {
                    return `
                        <path 
                            d="${country.path}" 
                            fill="${country.color}" 
                            stroke="#00ffff" 
                            stroke-width="0.5" 
                            opacity="0.8"
                            filter="url(#cyberpunkGlow)"
                            class="country-path"
                            data-country="${country.name}"
                        />
                    `;
                }).join('');
            }

            // Create country labels
            createCountryLabels(countryData) {
                const labelPositions = {
                    'India': { x: 680, y: 280 },
                    'United States': { x: 230, y: 250 },
                    'United Kingdom': { x: 475, y: 150 },
                    'Canada': { x: 220, y: 110 },
                    'Germany': { x: 515, y: 165 },
                    'Australia': { x: 850, y: 420 },
                    'France': { x: 485, y: 185 },
                    'Japan': { x: 910, y: 225 },
                    'Singapore': { x: 740, y: 330 },
                    'Netherlands': { x: 490, y: 150 },
                    'Brazil': { x: 320, y: 425 },
                    'Sweden': { x: 525, y: 115 },
                    'Switzerland': { x: 500, y: 185 },
                    'Norway': { x: 510, y: 105 },
                    'Russia': { x: 750, y: 140 },
                    'China': { x: 780, y: 240 },
                    'Mexico': { x: 200, y: 325 },
                    'Spain': { x: 460, y: 205 },
                    'Italy': { x: 520, y: 215 },
                    'South Korea': { x: 875, y: 230 },
                    'Thailand': { x: 730, y: 295 },
                    'Indonesia': { x: 790, y: 355 },
                    'Egypt': { x: 570, y: 270 },
                    'South Africa': { x: 565, y: 470 },
                    'New Zealand': { x: 950, y: 475 }
                };

                return countryData.slice(0, 8).map(country => {
                    const pos = labelPositions[country.country];
                    if (!pos) return '';
                    
                    return `
                        <g class="country-label" data-country="${country.country}">
                            <circle cx="${pos.x}" cy="${pos.y}" r="3" fill="#00ff88" opacity="0.8">
                                <animate attributeName="r" values="3;5;3" dur="2s" repeatCount="indefinite"/>
                            </circle>
                            <text x="${pos.x + 8}" y="${pos.y + 4}" 
                                  fill="#00ffff" 
                                  font-size="10" 
                                  font-weight="bold"
                                  text-shadow="0 0 5px #00ffff">
                                ${country.country}
                            </text>
                            <text x="${pos.x + 8}" y="${pos.y + 16}" 
                                  fill="#00ff88" 
                                  font-size="8" 
                                  font-weight="bold">
                                ${country.visits} visits
                            </text>
                        </g>
                    `;
                }).join('');
            }

            // Create visitor indicators
            createVisitorIndicators(countryData) {
                const indicatorPositions = {
                    'India': { x: 680, y: 280 },
                    'United States': { x: 230, y: 250 },
                    'United Kingdom': { x: 475, y: 150 },
                    'Canada': { x: 220, y: 110 },
                    'Germany': { x: 515, y: 165 },
                    'Australia': { x: 850, y: 420 },
                    'Japan': { x: 910, y: 225 },
                    'Singapore': { x: 740, y: 330 },
                    'Brazil': { x: 320, y: 425 },
                    'France': { x: 485, y: 185 }
                };

                return countryData.slice(0, 5).map((country, index) => {
                    const pos = indicatorPositions[country.country];
                    if (!pos) return '';
                    
                    const pulseDelay = index * 0.5;
                    
                    return `
                        <circle cx="${pos.x}" cy="${pos.y}" r="8" 
                                fill="none" 
                                stroke="#00ff88" 
                                stroke-width="1" 
                                opacity="0.6">
                            <animate attributeName="r" 
                                     values="8;15;8" 
                                     dur="3s" 
                                     begin="${pulseDelay}s"
                                     repeatCount="indefinite"/>
                            <animate attributeName="opacity" 
                                     values="0.6;0.2;0.6" 
                                     dur="3s" 
                                     begin="${pulseDelay}s"
                                     repeatCount="indefinite"/>
                        </circle>
                    `;
                }).join('');
            }

            // Add map interactivity
            addMapInteractivity(countryData) {
                const tooltip = document.createElement('div');
                tooltip.className = 'map-tooltip';
                document.body.appendChild(tooltip);

                const showTooltip = (countryInfo, e) => {
                    tooltip.innerHTML = `
                        <div class="tooltip-header">
                            <span class="country-flag">${countryInfo.flag}</span>
                            <strong>${countryInfo.country}</strong>
                        </div>
                        <div class="tooltip-stats">
                            <div>Visits: <span class="highlight">${countryInfo.visits}</span></div>
                            <div>Percentage: <span class="highlight">${countryInfo.percentage}%</span></div>
                        </div>
                    `;
                    tooltip.style.display = 'block';
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY - 50 + 'px';
                };

                const hideTooltip = () => {
                    tooltip.style.display = 'none';
                };

                const moveTooltip = (e) => {
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY - 50 + 'px';
                };

                // Add hover effects to country labels
                document.querySelectorAll('.country-label').forEach(label => {
                    const countryName = label.getAttribute('data-country');
                    const countryInfo = countryData.find(c => c.country === countryName);
                    
                    if (countryInfo) {
                        label.addEventListener('mouseenter', (e) => showTooltip(countryInfo, e));
                        label.addEventListener('mouseleave', hideTooltip);
                        label.addEventListener('mousemove', moveTooltip);
                    }
                });

                // Add hover effects to country paths
                document.querySelectorAll('.country-path').forEach(path => {
                    const countryName = path.getAttribute('data-country');
                    const countryInfo = countryData.find(c => c.country === countryName);
                    
                    if (countryInfo) {
                        path.addEventListener('mouseenter', (e) => showTooltip(countryInfo, e));
                        path.addEventListener('mouseleave', hideTooltip);
                        path.addEventListener('mousemove', moveTooltip);
                    } else {
                        // Show basic info for countries without visitor data
                        path.addEventListener('mouseenter', (e) => {
                            tooltip.innerHTML = `
                                <div class="tooltip-header">
                                    <span class="country-flag">🌍</span>
                                    <strong>${countryName}</strong>
                                </div>
                                <div class="tooltip-stats">
                                    <div>Visits: <span class="highlight">0</span></div>
                                    <div>No visitor data</div>
                                </div>
                            `;
                            tooltip.style.display = 'block';
                            tooltip.style.left = e.pageX + 10 + 'px';
                            tooltip.style.top = e.pageY - 50 + 'px';
                        });
                        path.addEventListener('mouseleave', hideTooltip);
                        path.addEventListener('mousemove', moveTooltip);
                    }
                });
            }
        }

        // Newsletter Management
        class NewsletterManager {
            constructor() {
                this.form = document.getElementById('newsletterForm');
                this.emailInput = document.getElementById('emailInput');
                this.submitButton = document.getElementById('subscribeButton');
                this.messageElement = document.getElementById('formMessage');
                
                this.initializeForm();
            }

            initializeForm() {
                this.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSubmission();
                });
            }

            async handleSubmission() {
                const email = this.emailInput.value.trim();
                
                if (!this.validateEmail(email)) {
                    this.showMessage('Please enter a valid email address.', 'error');
                    return;
                }

                this.setLoading(true);

                try {
                    // Store subscription locally and in CSV
                    const newSubscriber = {
                        email: email,
                        timestamp: new Date().toISOString(),
                        source: 'Personal Website Analytics Page',
                        status: 'active',
                        country: 'Unknown'
                    };
                    
                    // Update localStorage
                    const subscribers = JSON.parse(localStorage.getItem('newsletter_subscribers') || '[]');
                    if (!subscribers.find(sub => sub.email === email)) {
                        subscribers.push(newSubscriber);
                        localStorage.setItem('newsletter_subscribers', JSON.stringify(subscribers));
                    }
                    
                    // Update CSV data (no API needed)
                    await this.updateNewsletterCSV(newSubscriber);
                    
                    this.showMessage('Successfully subscribed! Welcome to the newsletter.', 'success');
                    this.emailInput.value = '';
                    
                } catch (error) {
                    console.error('Subscription error:', error);
                    this.showMessage('Something went wrong. Please try again later.', 'error');
                } finally {
                    this.setLoading(false);
                }
            }

            // Send subscription via EmailJS (optional - requires API setup)
            // async sendViaEmailJS(email) {
            //     const templateParams = {
            //         user_email: email,
            //         timestamp: new Date().toISOString(),
            //         source: 'Personal Website Analytics Page'
            //     };
            //     return emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', templateParams);
            // }

            // Alternative: Send subscription via Formspree (optional - requires setup)
            // async sendViaFormspree(email) {
            //     const response = await fetch('https://formspree.io/f/YOUR_FORM_ID', {
            //         method: 'POST',
            //         headers: {
            //             'Accept': 'application/json',
            //             'Content-Type': 'application/json'
            //         },
            //         body: JSON.stringify({
            //             email: email,
            //             message: 'Newsletter subscription from analytics page'
            //         })
            //     });
            //     if (!response.ok) {
            //         throw new Error('Subscription failed');
            //     }
            // }

            async updateNewsletterCSV(newSubscriber) {
                // In a real implementation, this would make an API call to update the server-side CSV
                // For now, we'll simulate the update by storing it in a special localStorage key
                const csvUpdates = JSON.parse(localStorage.getItem('csv_updates_newsletter') || '[]');
                
                const csvRow = {
                    email: newSubscriber.email.replace(/,/g, ''), // Remove commas to avoid CSV issues
                    timestamp: newSubscriber.timestamp,
                    source: newSubscriber.source,
                    status: newSubscriber.status,
                    country: newSubscriber.country
                };
                
                csvUpdates.push(csvRow);
                localStorage.setItem('csv_updates_newsletter', JSON.stringify(csvUpdates));
                
                console.log('Newsletter CSV update queued:', csvRow);
            }

            validateEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            setLoading(loading) {
                this.submitButton.disabled = loading;
                this.submitButton.innerHTML = loading 
                    ? '<div class="loading-spinner"></div> Subscribing...'
                    : '<i class="fas fa-paper-plane"></i> Subscribe';
            }

            showMessage(message, type) {
                this.messageElement.textContent = message;
                this.messageElement.className = `form-message ${type}`;
                this.messageElement.style.display = 'block';

                setTimeout(() => {
                    this.messageElement.style.display = 'none';
                }, 5000);
            }
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize analytics tracking
            new AnalyticsManager();
            
            // Initialize newsletter functionality
            new NewsletterManager();

            // Add some visual enhancements
            initializeVisualEffects();
        });

        // Visual effects for enhanced user experience
        function initializeVisualEffects() {
            // Animate cards on scroll
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver(function(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.animation = 'slideInUp 0.6s ease forwards';
                    }
                });
            }, observerOptions);

            // Observe all analytics cards
            document.querySelectorAll('.analytics-card').forEach(card => {
                observer.observe(card);
            });

            // Add slideInUp animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInUp {
                    from {
                        opacity: 0;
                        transform: translateY(30px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            `;
            document.head.appendChild(style);
        }
    </script>
</body>
</html>
